# Stage 2 ‚Äî ENT Diagnostic & Mastery
## üìã –î–µ—Ç–∞–ª—å–Ω—ã–π Roadmap —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

> **–ò—Å—Ç–æ—á–Ω–∏–∫–∏**: ENT_STAGE2_SPEC_V4_3.md, ENT_STAGE2_Rules.md, ent_reference.md  
> **–î–∞—Ç–∞**: 2026-02-05

---

## üéØ –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

**Stage 2** ‚Äî —Å–∏—Å—Ç–µ–º–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ï–ù–¢ —Å AI-–∞–Ω–∞–ª–∏–∑–æ–º –æ—à–∏–±–æ–∫.

### –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç Stage 1 (Trivia)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Stage 1 | Stage 2 |
|----------|---------|---------|
| –†–µ–∂–∏–º | Real-time –¥–ª—è –≤—Å–µ—Ö | –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π |
| –í—ã–±—ã–≤–∞–Ω–∏–µ | –î–∞ | –ù–µ—Ç |
| –í–æ–ø—Ä–æ—Å–æ–≤ | 10-15 | –¥–æ 120 |
| –í—Ä–µ–º—è | 10-15 —Å–µ–∫/–≤–æ–ø—Ä–æ—Å | 240 –º–∏–Ω –æ–±—â–∏–π |
| Scoring | 1 –±–∞–ª–ª | Partial + negative |
| AI | –ù–µ—Ç | –ê–Ω–∞–ª–∏–∑ + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ |

---

## üîí –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (—á–µ–∫–ª–∏—Å—Ç)

### –ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç **—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–ø—ã—Ç–∫–∏** (–±–∞–ª–ª, –æ—à–∏–±–∫–∏ –ø–æ —Ç–µ–º–∞–º/–≤–æ–ø—Ä–æ—Å–∞–º) –∏ **—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–ù–ï –≤–∏–¥–∏—Ç** –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ñ–æ—Ä–º—É–ª—ã, –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã, –≤–µ—Å–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ (topic_score, format_score, action_penalty –∏ —Ç.–ø.)
- [ ] AI —Ç–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç, **–Ω–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç** –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π
- [ ] Core-logic ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã

### –ü–æ–ø—ã—Ç–∫–∞ (Attempt)
- [ ] 5 –ø—Ä–µ–¥–º–µ—Ç–æ–≤ = 3 –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö + 2 –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã—Ö
- [ ] ‚â§120 –≤–æ–ø—Ä–æ—Å–æ–≤
- [ ] 240 –º–∏–Ω—É—Ç –æ–±—â–∏–π –ª–∏–º–∏—Ç + subject-—Ç–∞–π–º–µ—Ä—ã
- [ ] –§–æ—Ä–º–∞—Ç—ã: single_choice, multi_choice, matching, context

### –¢–∞–π–º–∞—É—Ç—ã
- [ ] Subject timeout ‚Üí –ø—Ä–µ–¥–º–µ—Ç –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –æ—Ç–≤–µ—Ç—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è
- [ ] Attempt timeout ‚Üí unanswered –ø–æ–ª—É—á–∞—é—Ç q_score=0, AI-signals —Å incomplete_attempt=true
- [ ] Time-per-question exceeded ‚Üí q_score=0, –ª–æ–≥ TimeExceeded
- [ ] –û—Ç–≤–µ—Ç –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞ ‚Üí –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ invalid_action

### Scoring
- [ ] Penalty –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –î–û —É–º–Ω–æ–∂–µ–Ω–∏—è –Ω–∞ weight –∏ difficulty
- [ ] –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª –≤–æ–ø—Ä–æ—Å–∞: 0
- [ ] AttemptScore = —Å—É–º–º–∞ –≤—Å–µ—Ö final_i, –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –∫ 0

### –ê–¥–∞–ø—Ç–∞—Ü–∏—è
- [ ] seed = attempt_id + user_id (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–±–æ—Ä)
- [ ] min/max –∫–≤–æ—Ç—ã –Ω–∞ —Ñ–æ—Ä–º–∞—Ç—ã
- [ ] action_penalty = a1√óskip_rate + a2√óchange_rate

### AI-—Å–∏–≥–Ω–∞–ª—ã
- [ ] –ê–≥—Ä–µ–≥–∞—Ü–∏—è **—Ç–æ–ª—å–∫–æ** –¥–ª—è incomplete_attempt=true
- [ ] –û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–∏–ª–∞—Å—å ‚Üí persistence‚Üë
- [ ] –û—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ ‚Üí persistence‚Üì
- [ ] –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Üí —Å–∏–≥–Ω–∞–ª **—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** (–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è!)

---

## üìÖ –≠—Ç–∞–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```
–≠—Ç–∞–ø 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö           ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  3 –¥–Ω—è
–≠—Ç–∞–ø 2: Entities + Repos      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    2 –¥–Ω—è
–≠—Ç–∞–ø 3: Core Services         ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  5 –¥–Ω–µ–π
–≠—Ç–∞–ø 4: Advanced Services     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  4 –¥–Ω—è
–≠—Ç–∞–ø 5: AI Layer              ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  4 –¥–Ω—è
–≠—Ç–∞–ø 6: API + –¢–µ—Å—Ç—ã           ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  5 –¥–Ω–µ–π
                              ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                              –ò—Ç–æ–≥–æ: ~23 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è
```

---

## –≠—Ç–∞–ø 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (3 –¥–Ω—è)

### –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è ENT —Å–∏—Å—Ç–µ–º—ã.

### –§–∞–π–ª—ã

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `migrations/000018_create_ent_subjects.up.sql` | –ü—Ä–µ–¥–º–µ—Ç—ã, —Ç–æ–ø–∏–∫–∏, –ø–æ–¥—Ç–æ–ø–∏–∫–∏ |
| `migrations/000018_create_ent_subjects.down.sql` | –û—Ç–∫–∞—Ç |
| `migrations/000019_create_ent_questions.up.sql` | –í–æ–ø—Ä–æ—Å—ã —Å format_type, difficulty, weight |
| `migrations/000019_create_ent_questions.down.sql` | –û—Ç–∫–∞—Ç |
| `migrations/000020_create_ent_attempts.up.sql` | –ü–æ–ø—ã—Ç–∫–∏, items, —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–µ–¥–º–µ—Ç–æ–≤ |
| `migrations/000020_create_ent_attempts.down.sql` | –û—Ç–∫–∞—Ç |
| `migrations/000021_create_ent_answers.up.sql` | –û—Ç–≤–µ—Ç—ã, –ª–æ–≥–∏ –≤—Ä–µ–º–µ–Ω–∏, –ª–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π |
| `migrations/000021_create_ent_answers.down.sql` | –û—Ç–∫–∞—Ç |
| `migrations/000022_create_ent_diagnostics.up.sql` | –û—à–∏–±–∫–∏, –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ —Ç–µ–º–∞–º/—Ñ–æ—Ä–º–∞—Ç–∞–º |
| `migrations/000022_create_ent_diagnostics.down.sql` | –û—Ç–∫–∞—Ç |
| `migrations/000023_create_ent_ai_layer.up.sql` | AI —Å–∏–≥–Ω–∞–ª—ã, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∞—É–¥–∏—Ç-–ª–æ–≥ |
| `migrations/000023_create_ent_ai_layer.down.sql` | –û—Ç–∫–∞—Ç |

### –¢–∞–±–ª–∏—Ü—ã

**–ö–æ–Ω—Ç–µ–Ω—Ç:**
- `ent_subjects` ‚Äî 5 –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (3 –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö + –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–µ)
- `ent_topics` ‚Äî —Ç–µ–º—ã –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–¥–º–µ—Ç–∞
- `ent_subtopics` ‚Äî –ø–æ–¥—Ç–µ–º—ã
- `ent_questions` ‚Äî –≤–æ–ø—Ä–æ—Å—ã —Å –ø–æ–ª—è–º–∏:
  - `format_type`: single_choice, multi_choice, matching, context
  - `difficulty_level`: easy, medium, hard
  - `weight`: –≤–µ—Å –≤–æ–ø—Ä–æ—Å–∞ (1.0 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  - `options`: JSONB —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–∞
  - `correct_answers`: JSONB —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏
  - `matching_pairs`: JSONB –¥–ª—è matching
  - `context_block_id`: –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ context-–≤–æ–ø—Ä–æ—Å–æ–≤

**–ü—Ä–æ—Ü–µ—Å—Å:**
- `ent_attempts` ‚Äî –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `status`: active | finished | timeout | aborted
  - `adaptation_seed`: attempt_id + user_id (–±–µ–∑ —Ö—ç—à–∞)
  - `subject_ids`: JSONB [1,2,3,4,5]
- `ent_attempt_items` ‚Äî –≤–æ–ø—Ä–æ—Å—ã –≤ –ø–æ–ø—ã—Ç–∫–µ
- `ent_attempt_subject_state` ‚Äî —Å—Ç–∞—Ç—É—Å –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (**–Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞**)
  - `is_blocked`: –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø—Ä–µ–¥–º–µ—Ç –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞
  - `blocked_at`: –∫–æ–≥–¥–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
- `ent_answers` ‚Äî –æ—Ç–≤–µ—Ç—ã
- `question_time_log` ‚Äî –≤—Ä–µ–º—è –Ω–∞ –≤–æ–ø—Ä–æ—Å
  - `is_time_exceeded`: —Ñ–ª–∞–≥ TimeExceeded
- `user_action_log` ‚Äî –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - action_type: skip, change_answer, navigate_back, navigate_forward, flag_question, **invalid_action**

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
- `ent_error_events` ‚Äî —Å–æ–±—ã—Ç–∏—è –æ—à–∏–±–æ–∫
- `ent_topic_profiles` ‚Äî –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —Ç–µ–º–∞–º
  - `ai_persistence_score`: –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π persistence
- `ent_format_profiles` ‚Äî –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —Ñ–æ—Ä–º–∞—Ç–∞–º

**AI Layer:**
- `ent_ai_signals` ‚Äî —Å–∏–≥–Ω–∞–ª—ã –æ—Ç AI
  - `is_incomplete_attempt`: —Ñ–ª–∞–≥ –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
- `ent_recommendations` ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
  - `audit_reason`: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ (–ø–æ Rules ¬ß7)
- `ent_ai_audit_log` ‚Äî –ª–æ–≥ AI
- `ent_reports` ‚Äî –æ—Ç—á—ë—Ç—ã

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
- [ ] –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] Down-–º–∏–≥—Ä–∞—Ü–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç
- [ ] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## –≠—Ç–∞–ø 2: Entities + Repositories (2 –¥–Ω—è)

### –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å Go-—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤.

### –§–∞–π–ª—ã

**Entities** (`internal/domain/entity/ent/`):

| –§–∞–π–ª | –°—Ç—Ä—É–∫—Ç—É—Ä–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----------|----------|
| `subject.go` | `EntSubject` | –ü—Ä–µ–¥–º–µ—Ç –ï–ù–¢ |
| `topic.go` | `EntTopic`, `EntSubtopic` | –¢–µ–º–∞, –ø–æ–¥—Ç–µ–º–∞ |
| `question.go` | `EntQuestion` | –í–æ–ø—Ä–æ—Å —Å format_type |
| `attempt.go` | `EntAttempt`, `EntAttemptItem`, `EntAttemptSubjectState` | –ü–æ–ø—ã—Ç–∫–∞ |
| `answer.go` | `EntAnswer` | –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `logs.go` | `QuestionTimeLog`, `UserActionLog` | –õ–æ–≥–∏ |
| `profiles.go` | `EntTopicProfile`, `EntFormatProfile` | –ü—Ä–æ—Ñ–∏–ª–∏ |
| `error_event.go` | `EntErrorEvent` | –°–æ–±—ã—Ç–∏–µ –æ—à–∏–±–∫–∏ |
| `ai.go` | `EntAISignal`, `EntRecommendation`, `EntAIAuditLog` | AI —Å—É—â–Ω–æ—Å—Ç–∏ |
| `report.go` | `EntReport` | –û—Ç—á—ë—Ç |

**Repository Interfaces** (`internal/domain/repository/ent/`):

| –§–∞–π–ª | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å | –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã |
|------|-----------|-----------------|
| `subject_repository.go` | `EntSubjectRepository` | FindMandatory, FindAll |
| `question_repository.go` | `EntQuestionRepository` | FindBySubjectAndFormat, FindForAdaptation |
| `attempt_repository.go` | `EntAttemptRepository` | Create, FindActive, UpdateStatus |
| `subject_state_repository.go` | `EntSubjectStateRepository` | FindByAttempt, BlockSubject |
| `answer_repository.go` | `EntAnswerRepository` | Create, FindByAttempt |
| `action_log_repository.go` | `EntActionLogRepository` | Create, CountSkips, CountChanges |
| `profile_repository.go` | `EntProfileRepository` | GetTopicProfile, UpdatePersistence |
| `ai_repository.go` | `EntAIRepository` | CreateSignal, FindIncompleteSignals |

**Repository Implementations** (`internal/repository/postgres/ent/`):
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ —Ñ–∞–π–ª—ã —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ GORM

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
- [ ] –í—Å–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏–º–µ—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ GORM-—Ç–µ–≥–∏
- [ ] –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ –Ω—É–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- [ ] –ö–æ–º–ø–∏–ª—è—Ü–∏—è –±–µ–∑ –æ—à–∏–±–æ–∫

---

## –≠—Ç–∞–ø 3: Core Services (5 –¥–Ω–µ–π)

### –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É.

### –§–∞–π–ª—ã (`internal/service/ent/`)

#### 3.1 AttemptService (2 –¥–Ω—è)

**–§–∞–π–ª**: `attempt_service.go`

**–ú–µ—Ç–æ–¥—ã**:

```go
// StartAttempt ‚Äî –Ω–∞—á–∞–ª–æ –ø–æ–ø—ã—Ç–∫–∏
// - –í–∞–ª–∏–¥–∞—Ü–∏—è: —Ä–æ–≤–Ω–æ 2 –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–∞
// - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç 3 –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö
// - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç seed = attempt_id + user_id (–∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è, –ù–ï —Ö—ç—à)
// - –°–æ–∑–¥–∞—ë—Ç —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞
func StartAttempt(userID uint, profileSubjectIDs []uint) (*EntAttempt, error)

// SubmitAnswer ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
// - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø—Ä–µ–¥–º–µ—Ç
// - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: –Ω–µ –∏—Å—Ç—ë–∫ –ª–∏ attempt
// - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω–æ –ª–∏ –≤—Ä–µ–º—è –Ω–∞ –≤–æ–ø—Ä–æ—Å
// - –õ–æ–≥–∏—Ä—É–µ—Ç TimeExceeded –µ—Å–ª–∏ –Ω–∞–¥–æ ‚Üí q_score=0
// - –õ–æ–≥–∏—Ä—É–µ—Ç invalid_action –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞
func SubmitAnswer(attemptID, questionID uint, answer Request) (*Result, error)

// HandleSubjectTimeout ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞
// - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç is_blocked=true
// - –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ: –æ—Ç–≤–µ—Ç—ã –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ ent_answers (rejected)
// - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è invalid_action
// - Attempt –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –ø–æ –¥—Ä—É–≥–∏–º –ø—Ä–µ–¥–º–µ—Ç–∞–º
func HandleSubjectTimeout(attemptID, subjectID uint) error

// HandleAttemptTimeout ‚Äî –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ —Ç–∞–π–º–∞—É—Ç—É
// - –í—Å–µ unanswered ‚Üí q_score=0
// - –°—Ç–∞—Ç—É—Å ‚Üí timeout
// - AI –∞–Ω–∞–ª–∏–∑ —Å incomplete_attempt=true
func HandleAttemptTimeout(ctx context.Context, attemptID uint) error {
    // AI signals saved with incomplete_attempt=true (SPEC ¬ßTimeouts)
    // –í–ê–ñ–ù–û: AnalyzeAttempt –ì–ê–†–ê–ù–¢–ò–†–£–ï–¢ —á—Ç–æ –í–°–ï —Å–∏–≥–Ω–∞–ª—ã –≤–Ω—É—Ç—Ä–∏ –ø–æ–ø—ã—Ç–∫–∏
    // —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Å is_incomplete_attempt=true
    s.aiService.AnalyzeAttempt(ctx, attemptID, true /* isIncomplete */)
    
    return nil
}

// –í AIService.AnalyzeAttempt:
// func (s *AIService) AnalyzeAttempt(attemptID uint, isIncomplete bool) {
//     signals := s.generateSignals(attemptID)
//     for _, signal := range signals {
//         signal.IsIncompleteAttempt = isIncomplete  // <-- –í–°–ï–ú —Å–∏–≥–Ω–∞–ª–∞–º
//         s.repo.Create(signal)
//     }
// }
// FinishAttempt ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
// - –ü–æ–¥—Å—á—ë—Ç –∏—Ç–æ–≥–æ–≤–æ–≥–æ AttemptScore
// - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π
// - –ó–∞–ø—É—Å–∫ AI –∞–Ω–∞–ª–∏–∑–∞
// - –í–û–ó–í–†–ê–©–ê–ï–¢: total_score + —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫ –ø–æ —Ç–µ–º–∞–º/–≤–æ–ø—Ä–æ—Å–∞–º
// - –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç: topic_score, format_score, action_penalty, –≤–µ—Å–∞/—Ñ–æ—Ä–º—É–ª—ã
func FinishAttempt(attemptID uint) (*AttemptResult, error)

// AttemptResult ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –≤–∏–¥–∏–º—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
type AttemptResult struct {
    AttemptID      uint            `json:"attempt_id"`
    TotalScore     float64         `json:"total_score"`
    TotalQuestions int             `json:"total_questions"`
    CorrectCount   int             `json:"correct_count"`
    ErrorsByTopic  []TopicErrors   `json:"errors_by_topic"`
    // –ù–ï–¢: topic_score, format_score, action_penalty, weights
}
```

#### 3.2 ScoringService (1 –¥–µ–Ω—å)

**–§–∞–π–ª**: `scoring_service.go`

**–§–æ—Ä–º—É–ª—ã** (—Ç–æ—á–Ω–æ –ø–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏):

```go
// Single Choice
// q_score = 1 –µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∏–Ω–∞—á–µ 0
// final = max(0, q_score - penalty) √ó weight √ó difficulty_multiplier

// Multi Choice  
// q_score = (correct_selected / total_correct) - (incorrect_selected / total_incorrect)
// q_score = max(0, q_score)
// final = max(0, q_score - penalty) √ó weight √ó difficulty_multiplier

// Matching
// q_score = correct_pairs / total_pairs
// final = max(0, q_score - penalty) √ó weight √ó difficulty_multiplier

// Context
// q_score = correct_subanswers / total_subanswers
// final = max(0, q_score - penalty) √ó weight √ó difficulty_multiplier

// difficulty_multiplier: easy=0.8, medium=1.0, hard=1.2
```

**–ú–µ—Ç–æ–¥—ã**:
- `ScoreSingleChoice(answer, question) float64`
- `ScoreMultiChoice(answer, question) float64`
- `ScoreMatching(answer, question) float64`
- `ScoreContext(answer, question) float64`
- `AggregateAttemptScore(attemptID) float64` ‚Äî —Å—É–º–º–∞, –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫ 0

#### 3.3 DiagnosticsService (2 –¥–Ω—è)

**–§–∞–π–ª**: `diagnostics_service.go`

**–ú–µ—Ç–æ–¥—ã**:
- `RecordError(...)` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ EntErrorEvent
- `UpdateTopicProfile(...)` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Ç–µ–º—ã
- `UpdateFormatProfile(...)` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Ñ–æ—Ä–º–∞—Ç–∞
- `GetUserDiagnostics(userID)` ‚Äî –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–ª—è –æ—Ç—á—ë—Ç–æ–≤

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
- [ ] Scoring —Ñ–æ—Ä–º—É–ª—ã —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
- [ ] Timeout-–ª–æ–≥–∏–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [ ] invalid_action –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞
- [ ] Unit-—Ç–µ—Å—Ç—ã –¥–ª—è scoring

---

## –≠—Ç–∞–ø 4: Advanced Services (4 –¥–Ω—è)

### –§–∞–π–ª—ã (`internal/service/ent/`)

#### 4.1 AdaptationService (2 –¥–Ω—è)

**–§–∞–π–ª**: `adaptation_service.go`

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:

1. **–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–±–æ—Ä** (SPEC ¬ßAdaptation):
```go
// seed = attempt_id + user_id (–ù–ï —Ö—ç—à, –ø—Ä–æ—Å—Ç–æ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏)
// –ü—Ä–∏–º–µ—Ä: attemptID=100, userID=5 ‚Üí seed = "100_5"
func generateSeed(attemptID, userID uint) string {
    return fmt.Sprintf("%d_%d", attemptID, userID)
}
```

2. **–ö–≤–æ—Ç—ã —Ñ–æ—Ä–º–∞—Ç–æ–≤** (SPEC ¬ßAdaptation: min/max):
```go
type FormatQuota struct {
    FormatType string
    MinPercent int  // –º–∏–Ω–∏–º—É–º % –≤–æ–ø—Ä–æ—Å–æ–≤ —ç—Ç–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
    MaxPercent int  // –º–∞–∫—Å–∏–º—É–º % –≤–æ–ø—Ä–æ—Å–æ–≤ —ç—Ç–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
}

var Quotas = []FormatQuota{
    {"single_choice", 30, 60},
    {"multi_choice", 20, 40},
    {"matching", 10, 25},
    {"context", 10, 25},
}

// checkFormatQuotas –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ò min –ò max
func (s *AdaptationService) checkFormatQuotas(counts map[string]int, total int) bool {
    for _, q := range Quotas {
        currentPercent := float64(counts[q.FormatType]) / float64(total) * 100
        if currentPercent < float64(q.MinPercent) {
            return false  // min –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç
        }
        if currentPercent > float64(q.MaxPercent) {
            return false  // max –ø—Ä–µ–≤—ã—à–µ–Ω
        }
    }
    return true
}

// –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –≤–æ–ø—Ä–æ—Å–æ–≤: —Å–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω—è–µ–º min-–∫–≤–æ—Ç—ã, –ø–æ—Ç–æ–º –¥–æ–±–∏—Ä–∞–µ–º –¥–æ total
```

3. **–†–∞—Å—á—ë—Ç topic_score**:
```go
// topic_score = w1√óerror_count + w2√órepeat_count + w3√óai_persistence 
//             - w4√óstability + action_penalty
```

4. **–†–∞—Å—á—ë—Ç action_penalty** (SPEC ¬ßLogging):
```go
// action_penalty = a1√óskip_rate + a2√óchange_rate
// 
// –í–ê–ñ–ù–û: denominator = –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –ø–æ–ø—ã—Ç–∫–µ (ent_attempt_items),
// –∞ –ù–ï –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö. –≠—Ç–æ –¥–∞—ë—Ç —á–µ—Å—Ç–Ω—É—é –æ—Ü–µ–Ω–∫—É skip/change rate.
//
// skip_rate = –∫–æ–ª-–≤–æ skip / len(attempt_items)
// change_rate = –∫–æ–ª-–≤–æ change_answer / len(attempt_items)
func (s *AdaptationService) calculateActionPenalty(attemptID uint) float64 {
    actions := s.actionLogRepo.FindByAttempt(attemptID)
    totalItems := s.attemptItemRepo.CountByAttempt(attemptID)  // –í–°–ï –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ø—ã—Ç–∫–∏
    
    skipCount := countByType(actions, "skip")
    changeCount := countByType(actions, "change_answer")
    
    const a1, a2 = 0.3, 0.2
    return a1*float64(skipCount)/float64(totalItems) + a2*float64(changeCount)/float64(totalItems)
}
```

5. **Difficulty progression**:
- –°–ª–∞–±—ã–µ —Ç–µ–º—ã ‚Üí easy/medium –≤–æ–ø—Ä–æ—Å—ã
- –£–ª—É—á—à–µ–Ω–∏–µ ‚Üí harder –≤–æ–ø—Ä–æ—Å—ã
- –ü–æ–≤—Ç–æ—Ä –æ—à–∏–±–æ–∫ ‚Üí –æ—Ç–∫–∞—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

**–ú–µ—Ç–æ–¥—ã**:
- `SelectQuestions(userID, attemptID, subjectIDs, limit)` ‚Äî –≤—ã–±–æ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤
- `CalculateTopicScore(profile, actionPenalty)` ‚Äî —Å–∫–æ—Ä —Ç–µ–º—ã
- `CalculateFormatScore(profile, actionPenalty)` ‚Äî —Å–∫–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞

#### 4.2 RecommendationService (1 –¥–µ–Ω—å)

**–§–∞–π–ª**: `recommendation_service.go`

**–¢–∏–ø—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π**:
- `topic_repeat` ‚Äî –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ–º—É
- `format_review` ‚Äî –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç
- `combined` ‚Äî —Ç–µ–º–∞ + —Ñ–æ—Ä–º–∞—Ç

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã**: high, medium, low

**–ú–µ—Ç–æ–¥—ã**:
- `GenerateRecommendations(userID, attemptID)` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
- `GetActiveRecommendations(userID)` ‚Äî —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö
- `MarkCompleted(recommendationID)` ‚Äî –æ—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π

> ‚ö†Ô∏è **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**: –∫–∞–∂–¥–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å `audit_reason`

#### 4.3 ReportingService (1 –¥–µ–Ω—å)

**–§–∞–π–ª**: `reporting_service.go`

**–¢–∏–ø—ã –æ—Ç—á—ë—Ç–æ–≤**:
- `daily` ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π
- `weekly` ‚Äî –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π
- `attempt` ‚Äî –ø–æ –ø–æ–ø—ã—Ç–∫–µ

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
- [ ] –ö–≤–æ—Ç—ã —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Å–æ–±–ª—é–¥–∞—é—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
- [ ] –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–±–æ—Ä –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º
- [ ] action_penalty —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–º–µ—é—Ç audit_reason

---

## –≠—Ç–∞–ø 5: AI Layer (4 –¥–Ω—è)

### –§–∞–π–ª—ã

#### 5.1 AIService (3 –¥–Ω—è)

**–§–∞–π–ª**: `internal/service/ent/ai_service.go`

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** (`config/config.yaml`):
```yaml
ai:
  provider: "google"  # –∏–ª–∏ –¥—Ä—É–≥–æ–π
  model: "gemini-1.5-flash"
  temperature: 0.3
  max_tokens: 2000
```

**–ö–ª—é—á–µ–≤–∞—è –ª–æ–≥–∏–∫–∞ ‚Äî –∞–≥—Ä–µ–≥–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤**:

```go
// AggregateSignals ‚Äî –∞–≥—Ä–µ–≥–∞—Ü–∏—è –¥–ª—è incomplete attempts
func (s *AIService) AggregateSignals(userID, questionID uint, hasError bool) {
    prevSignal := s.repo.FindByUserAndQuestion(userID, questionID)
    
    // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–∏–≥–Ω–∞–ª –æ—Ç incomplete attempt!
    if prevSignal == nil || !prevSignal.IsIncompleteAttempt {
        return
    }
    
    prevHadError := prevSignal.ErrorType != ""
    
    if prevHadError && hasError {
        // –û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–∏–ª–∞—Å—å ‚Üí persistence‚Üë
        prevSignal.PersistenceSignal = increase(prevSignal.PersistenceSignal)
    } else if prevHadError && !hasError {
        // –û—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ ‚Üí persistence‚Üì
        prevSignal.PersistenceSignal = decrease(prevSignal.PersistenceSignal)
    }
    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Äî —Å–∏–≥–Ω–∞–ª –ù–ï –º–µ–Ω—è–µ—Ç—Å—è!
    
    s.repo.Update(prevSignal)
}
```

**–ú–µ—Ç–æ–¥—ã**:
- `AnalyzeAttempt(attemptID, isIncomplete)` ‚Äî –∞–Ω–∞–ª–∏–∑ –ø–æ–ø—ã—Ç–∫–∏
- `AggregateSignals(userID, questionID, hasError)` ‚Äî –∞–≥—Ä–µ–≥–∞—Ü–∏—è
- `GenerateSignal(error, context) EntAISignal` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞

#### 5.2 AI Audit Log

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ Rules ¬ß6**:
- –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ—à–∏–±–∫–∏, —Ç–µ–º—ã, –∏—Å—Ç–æ—Ä–∏—è)
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–∏
- –ü—Ä–∏—á–∏–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- attempt_id

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
- [ ] –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è is_incomplete_attempt=true
- [ ] "–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π" –Ω–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Å–∏–≥–Ω–∞–ª
- [ ] Audit log —Å–æ–∑–¥–∞—ë—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

---

## –≠—Ç–∞–ø 6: API + –¢–µ—Å—Ç—ã (5 –¥–Ω–µ–π)

### 6.1 API Handler (2 –¥–Ω—è)

**–§–∞–π–ª**: `internal/handler/ent_handler.go`

**Public API** (–∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏):

| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| POST | `/api/ent/attempts/start` | –ù–∞—á–∞—Ç—å –ø–æ–ø—ã—Ç–∫—É |
| POST | `/api/ent/attempts/{id}/answer` | –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç |
| POST | `/api/ent/attempts/{id}/finish` | –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç) |
| GET | `/api/ent/attempts/{id}/result` | –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ø—ã—Ç–∫–∏ (–ø–æ–≤—Ç–æ—Ä–Ω–æ) |
| POST | `/api/ent/attempts/{id}/action` | –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ |
| GET | `/api/ent/profile` | –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| GET | `/api/ent/recommendations` | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ |
| GET | `/api/ent/reports/daily` | –î–Ω–µ–≤–Ω–æ–π –æ—Ç—á—ë—Ç |
| GET | `/api/ent/reports/weekly` | –ù–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç |

**Internal API**:

| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| POST | `/internal/ent/ai/analyze-attempt` | AI –∞–Ω–∞–ª–∏–∑ |

### ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è API (Rules ¬ß1 ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–æ)

> **¬´–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–ø—ã—Ç–∫–∏ (–±–∞–ª–ª, –æ—à–∏–±–∫–∏ –ø–æ —Ç–µ–º–∞–º/–≤–æ–ø—Ä–æ—Å–∞–º) –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –Ω–æ –Ω–µ –≤–∏–¥–∏—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ñ–æ—Ä–º—É–ª—ã, –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã, –≤–µ—Å–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏¬ª**

**–ß—Ç–æ –ú–û–ñ–ù–û –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å**:
- `total_score` ‚Äî –∏—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª
- –û—à–∏–±–∫–∏ –ø–æ —Ç–µ–º–∞–º/–≤–æ–ø—Ä–æ—Å–∞–º (topic_name, question_id, is_correct)
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–∑–∞–≥–æ–ª–æ–≤–æ–∫, –æ–ø–∏—Å–∞–Ω–∏–µ, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, next_review_at)

**–ß—Ç–æ –ù–ï–õ–¨–ó–Ø –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å**:
- topic_score, format_score
- stability_score, ai_persistence_score
- action_penalty
- –§–æ—Ä–º—É–ª—ã, –≤–µ—Å–∞ (w1, w2, a1, a2), –º–Ω–æ–∂–∏—Ç–µ–ª–∏
- difficulty_multiplier, weight (—Ç–æ–ª—å–∫–æ –¥–ª—è internal)

### 6.2 –¢–µ—Å—Ç—ã (3 –¥–Ω—è)

**Unit-—Ç–µ—Å—Ç—ã** (`internal/service/ent/*_test.go`):
- [ ] ScoringService: –≤—Å–µ 4 —Ñ–æ—Ä–º—É–ª—ã
- [ ] AdaptationService: –∫–≤–æ—Ç—ã —Ñ–æ—Ä–º–∞—Ç–æ–≤
- [ ] AdaptationService: –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π seed
- [ ] AttemptService: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞
- [ ] AttemptService: –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞
- [ ] AIService: –∞–≥—Ä–µ–≥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è incomplete
- [ ] AIService: "–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π" —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–∏–≥–Ω–∞–ª
- [ ] **API: –æ—Ç–≤–µ—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç score –∏ –æ—à–∏–±–∫–∏, –ù–ï —Å–æ–¥–µ—Ä–∂–∞—Ç internal-–º–µ—Ç—Ä–∏–∫–∏**

**Integration-—Ç–µ—Å—Ç—ã**:
- [ ] –ü–æ–ª–Ω—ã–π flow –ø–æ–ø—ã—Ç–∫–∏ —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏
- [ ] –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
- [ ] –ë–∞–ª–∞–Ω—Å —Ñ–æ—Ä–º–∞—Ç–æ–≤ –Ω–∞ 120 –≤–æ–ø—Ä–æ—Å–∞—Ö

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
- [ ] API —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
- [ ] –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∞—Å—á—ë—Ç—ã —Å–∫—Ä—ã—Ç—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

---

## üìÅ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
trivia-api/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ config.yaml                     [MODIFY] –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é ai
‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îú‚îÄ‚îÄ 000018_create_ent_subjects.up.sql    [NEW]
‚îÇ   ‚îú‚îÄ‚îÄ 000018_create_ent_subjects.down.sql  [NEW]
‚îÇ   ‚îú‚îÄ‚îÄ 000019_create_ent_questions.up.sql   [NEW]
‚îÇ   ‚îú‚îÄ‚îÄ 000019_create_ent_questions.down.sql [NEW]
‚îÇ   ‚îú‚îÄ‚îÄ 000020_create_ent_attempts.up.sql    [NEW]
‚îÇ   ‚îú‚îÄ‚îÄ 000020_create_ent_attempts.down.sql  [NEW]
‚îÇ   ‚îú‚îÄ‚îÄ 000021_create_ent_answers.up.sql     [NEW]
‚îÇ   ‚îú‚îÄ‚îÄ 000021_create_ent_answers.down.sql   [NEW]
‚îÇ   ‚îú‚îÄ‚îÄ 000022_create_ent_diagnostics.up.sql [NEW]
‚îÇ   ‚îú‚îÄ‚îÄ 000022_create_ent_diagnostics.down.sql [NEW]
‚îÇ   ‚îú‚îÄ‚îÄ 000023_create_ent_ai_layer.up.sql    [NEW]
‚îÇ   ‚îî‚îÄ‚îÄ 000023_create_ent_ai_layer.down.sql  [NEW]
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entity/ent/                 [NEW] 10 —Ñ–∞–π–ª–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ repository/ent/             [NEW] 8 –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ repository/postgres/ent/        [NEW] 8 —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ service/ent/                    [NEW]
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ attempt_service.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ attempt_service_test.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ scoring_service.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ scoring_service_test.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ diagnostics_service.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ adaptation_service.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ adaptation_service_test.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ recommendation_service.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reporting_service.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai_service.go
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ai_service_test.go
‚îÇ   ‚îî‚îÄ‚îÄ handler/
‚îÇ       ‚îî‚îÄ‚îÄ ent_handler.go              [NEW]
‚îî‚îÄ‚îÄ cmd/api/
    ‚îî‚îÄ‚îÄ main.go                         [MODIFY] DI –¥–ª—è ENT —Å–µ—Ä–≤–∏—Å–æ–≤
```

---

## üìä –°–≤–æ–¥–∫–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –ù–æ–≤—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π | 12 —Ñ–∞–π–ª–æ–≤ (6 up + 6 down) |
| –ù–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü | 15 |
| –ù–æ–≤—ã—Ö entities | 12 |
| –ù–æ–≤—ã—Ö services | 6 |
| –ù–æ–≤—ã—Ö API endpoints | 9 |
| –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Å—Ä–æ–∫ | 23 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è (~5 –Ω–µ–¥–µ–ª—å) |

---

## ‚úÖ Definition of Done

–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫–æ–≥–¥–∞:

1. ‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∏ –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è
2. ‚úÖ 5 –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è (3+2)
3. ‚úÖ –¢–∞–π–º–∞—É—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. ‚úÖ Scoring —Ç–æ—á–Ω–æ –ø–æ —Ñ–æ—Ä–º—É–ª–∞–º
5. ‚úÖ AI –∞–≥—Ä–µ–≥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è incomplete
6. ‚úÖ API —Å–∫—Ä—ã–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∞—Å—á—ë—Ç—ã
7. ‚úÖ –í—Å–µ unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
