# –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Trivia

## –¶–µ–ª—å

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –∫—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–µ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (iOS/Android) –Ω–∞ Expo React Native —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º auth-–∫–æ–Ω—Ç—É—Ä–æ–º, –Ω–µ –ª–æ–º–∞—è —Ç–µ–∫—É—â–∏–π web-–∫–ª–∏–µ–Ω—Ç.

---

## –ü—Ä–∏–Ω—è—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è

| –†–µ—à–µ–Ω–∏–µ | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|---------|-------------|
| **Expo React Native** | –û–ø—Ç–∏–º–∞–ª–µ–Ω –¥–ª—è real-time –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã. WebSocket, Secure Storage, push ‚Äî –∏–∑ –∫–æ—Ä–æ–±–∫–∏. Discord, Shopify, Coinbase –∏—Å–ø–æ–ª—å–∑—É—é—Ç Expo |
| **–Ø–≤–Ω—ã–µ mobile endpoints** `/api/mobile/auth/*` | –ù–µ ¬´–º–∞–≥–∏—á–µ—Å–∫–æ–µ¬ª –ø–æ–≤–µ–¥–µ–Ω–∏–µ –æ–¥–Ω–∏—Ö endpoints –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º. –Ø–≤–Ω–æ, –ø—Ä–æ—Å—Ç–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å. Service-–ª–æ–≥–∏–∫–∞ –æ–±—â–∞—è |
| **–ù–µ –æ—Å–ª–∞–±–ª—è—Ç—å CSRF –≥–ª–æ–±–∞–ª—å–Ω–æ** | –û—Ç–¥–µ–ª—å–Ω—ã–π ws-ticket endpoint –¥–ª—è mobile, RequireCSRF –Ω–µ —Ç—Ä–æ–≥–∞–µ–º |
| **Shared-–∫–æ–Ω—Ç—Ä–∞–∫—Ç –≤ workspace** | –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–∞–∫–µ—Ç –≤ –º–æ–Ω–æ—Ä–µ–ø–µ (–Ω–µ npm publish). –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Ç–∏–ø–æ–≤ DTO/WS –¥–ª—è web –∏ mobile |
| **Admin = web-only** | –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–º–∏–Ω–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞ –Ω–∞ –¥–∞–Ω–Ω–æ–º —ç—Ç–∞–ø–µ |
| **–°—Ä–æ–∫–∏: 3‚Äì5 –Ω–µ–¥–µ–ª—å** | –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Å —É—á—ë—Ç–æ–º QA, edge-cases, web-—Ä–µ–≥—Ä–µ—Å—Å–∏–∏ |

---

## –§–∞–∑–∞ 1: Backend ‚Äî Mobile Auth Flow (3‚Äì5 –¥–Ω–µ–π)

### –ß—Ç–æ –¥–µ–ª–∞–µ–º

–î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é –≥—Ä—É–ø–ø—É –º–∞—Ä—à—Ä—É—Ç–æ–≤ `/api/mobile/auth/*` —Å Bearer + Refresh-–≤-JSON, –±–µ–∑ cookies –∏ CSRF. –í—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ ([AuthService](file:///c:/project/vmdeploy/trivia-api/internal/service/auth_service.go#18-25), [TokenManager](file:///c:/project/vmdeploy/trivia-api/pkg/auth/manager/token_manager.go#119-135)).

### –§–∞–π–ª—ã

---

#### [NEW] `internal/handler/mobile_auth_handler.go`

–ù–æ–≤—ã–π handler –¥–ª—è mobile-–∫–ª–∏–µ–Ω—Ç–æ–≤. –°–æ–¥–µ—Ä–∂–∏—Ç:

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç |
|-------|------|-----------|
| `MobileLogin` | `POST /api/mobile/auth/login` | –í—ã–∑—ã–≤–∞–µ—Ç `authService.LoginUser()`, –Ω–æ –≤–º–µ—Å—Ç–æ cookies –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `accessToken` + [refreshToken](file:///c:/project/vmdeploy/trivia-apinewfront/src/lib/api/auth.ts#53-76) –≤ JSON |
| `MobileRegister` | `POST /api/mobile/auth/register` | –í—ã–∑—ã–≤–∞–µ—Ç `authService.RegisterUser()` + `tokenManager.GenerateTokenPair()`, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã –≤ JSON |
| `MobileRefresh` | `POST /api/mobile/auth/refresh` | –ü—Ä–∏–Ω–∏–º–∞–µ—Ç `refresh_token` –∏–∑ JSON body (–Ω–µ –∏–∑ cookie), –±–µ–∑ CSRF-–ø—Ä–æ–≤–µ—Ä–∫–∏ |
| `MobilLogout` | `POST /api/mobile/auth/logout` | –ü—Ä–∏–Ω–∏–º–∞–µ—Ç `refresh_token` –∏–∑ JSON body, –≤—ã–∑—ã–≤–∞–µ—Ç `authService.LogoutUser()` |
| `MobileWsTicket` | `POST /api/mobile/auth/ws-ticket` | –¢–æ–ª—å–∫–æ [RequireAuth()](file:///c:/project/vmdeploy/trivia-api/internal/middleware/auth_middleware.go#28-96) (–±–µ–∑ [RequireCSRF()](file:///c:/project/vmdeploy/trivia-api/internal/middleware/auth_middleware.go#121-237)), –≤—ã–∑—ã–≤–∞–µ—Ç —Ç–æ—Ç –∂–µ `authService.GenerateWsTicket()` |

**–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç web handlers:**
- –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç `SetRefreshTokenCookie`, `SetAccessTokenCookie`, `SetCSRFSecretCookie`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç [refreshToken](file:///c:/project/vmdeploy/trivia-apinewfront/src/lib/api/auth.ts#53-76) –≤ JSON (–≤ web-–≤–µ—Ä—Å–∏–∏ –æ–Ω `json:"-"`)
- –ù–ï —Ç—Ä–µ–±—É–µ—Ç CSRF validation

**–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ª–æ–≥–∏–∫–∞:**
- `authService.LoginUser()` ‚Äî —Ç–∞ –∂–µ —Ñ—É–Ω–∫—Ü–∏—è, —á—Ç–æ –∏ –≤ web
- `authService.RegisterUser()` ‚Äî —Ç–∞ –∂–µ
- `tokenManager.GenerateTokenPair()` ‚Äî —Ç–∞ –∂–µ
- `authService.RefreshTokens()` ‚Äî –Ω—É–∂–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ CSRF (—Å–º. –Ω–∏–∂–µ)
- `authService.GenerateWsTicket()` ‚Äî —Ç–∞ –∂–µ

---

#### [MODIFY] [internal/service/auth_service.go](file:///c:/project/vmdeploy/trivia-api/internal/service/auth_service.go)

–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `RefreshTokensMobile(refreshToken, deviceID, ipAddress, userAgent string)` ‚Äî –∞–Ω–∞–ª–æ–≥ [RefreshTokens](file:///c:/project/vmdeploy/trivia-api/internal/service/auth_service.go#136-156), –Ω–æ –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `csrfToken`. –í–Ω—É—Ç—Ä–∏ –≤—ã–∑—ã–≤–∞–µ—Ç `tokenManager.RefreshTokenPair()` —Å —Ç–µ–º–∏ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, –ø—Ä–æ—Å—Ç–æ –±–µ–∑ CSRF-–≤–∞–ª–∏–¥–∞—Ü–∏–∏.

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ: —Å–¥–µ–ª–∞—Ç—å CSRF-–ø–∞—Ä–∞–º–µ—Ç—Ä –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ = –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å CSRF check). –†–µ—à–µ–Ω–∏–µ ‚Äî –Ω–∞ —Ä–µ–≤—å—é.

---

#### [MODIFY] [cmd/api/main.go](file:///c:/project/vmdeploy/trivia-api/cmd/api/main.go)

–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É –º–∞—Ä—à—Ä—É—Ç–æ–≤:

```go
// Mobile auth endpoints (Bearer + JSON, no cookies/CSRF)
mobileAuth := api.Group("/mobile/auth")
{
    mobileAuth.POST("/login", mobileAuthHandler.MobileLogin)
    mobileAuth.POST("/register", mobileAuthHandler.MobileRegister)
    mobileAuth.POST("/refresh", mobileAuthHandler.MobileRefresh)
    
    // –¢—Ä–µ–±—É—é—Ç Bearer auth, –Ω–æ –ù–ï CSRF
    mobileAuthed := mobileAuth.Group("/")
    mobileAuthed.Use(authMiddleware.RequireAuth())
    {
        mobileAuthed.POST("/logout", mobileAuthHandler.MobileLogout)
        mobileAuthed.POST("/ws-ticket", mobileAuthHandler.MobileWsTicket)
    }
}
```

---

#### –ù–ï —Ç—Ä–æ–≥–∞–µ–º:
- [auth_middleware.go](file:///c:/project/vmdeploy/trivia-api/internal/middleware/auth_middleware.go) ‚Äî [RequireCSRF()](file:///c:/project/vmdeploy/trivia-api/internal/middleware/auth_middleware.go#121-237) –æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ web-–º–∞—Ä—à—Ä—É—Ç—ã ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- [QuizWebSocketProvider.tsx](file:///c:/project/vmdeploy/trivia-apinewfront/src/providers/QuizWebSocketProvider.tsx) ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- [client.ts](file:///c:/project/vmdeploy/trivia-apinewfront/src/lib/api/client.ts) ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### Definition of Done ‚Äî –§–∞–∑–∞ 1

- [ ] `go build ./cmd/api` –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] `go test ./...` ‚Äî –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (9 test-—Ñ–∞–π–ª–æ–≤)
- [ ] –ù–æ–≤—ã–µ unit-—Ç–µ—Å—Ç—ã –¥–ª—è `MobileLogin`, `MobileRefresh`, `MobileWsTicket`
- [ ] –†—É—á–Ω–æ–π —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ curl/Postman:
  - `POST /api/mobile/auth/register` ‚Üí –ø–æ–ª—É—á–∏—Ç—å `accessToken` + [refreshToken](file:///c:/project/vmdeploy/trivia-apinewfront/src/lib/api/auth.ts#53-76) –≤ JSON
  - `POST /api/mobile/auth/login` ‚Üí –ø–æ–ª—É—á–∏—Ç—å `accessToken` + [refreshToken](file:///c:/project/vmdeploy/trivia-apinewfront/src/lib/api/auth.ts#53-76) –≤ JSON
  - `POST /api/mobile/auth/refresh` —Å `refresh_token` –≤ body ‚Üí –Ω–æ–≤–∞—è –ø–∞—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤
  - `POST /api/mobile/auth/ws-ticket` —Å `Authorization: Bearer <token>` ‚Üí –ø–æ–ª—É—á–∏—Ç—å ticket
  - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ `/ws?ticket=<ticket>` ‚Üí WebSocket –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- [ ] Web-–∫–ª–∏–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ (—Ä–µ–≥—Ä–µ—Å—Å–∏—è)

---

## –§–∞–∑–∞ 2: Shared-–∫–æ–Ω—Ç—Ä–∞–∫—Ç –≤ –º–æ–Ω–æ—Ä–µ–ø–µ (1‚Äì2 –¥–Ω—è)

### –ß—Ç–æ –¥–µ–ª–∞–µ–º

–í—ã–¥–µ–ª—è–µ–º –æ–±—â–∏–µ —Ç–∏–ø—ã –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π workspace-–ø–∞–∫–µ—Ç. –ù–µ npm publish ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º repo.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
project/
‚îú‚îÄ‚îÄ trivia-api/        # Backend (Go) ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
‚îú‚îÄ‚îÄ trivia-apinewfront/ # Web frontend (Next.js)
‚îÇ   ‚îú‚îÄ‚îÄ package.json   # workspace: ["../shared"]
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ trivia-mobile/     # Mobile app (Expo) ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ –§–∞–∑–µ 3
‚îÇ   ‚îú‚îÄ‚îÄ package.json   # workspace: ["../shared"]
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ shared/            # –û–±—â–∏–µ —Ç–∏–ø—ã
    ‚îú‚îÄ‚îÄ package.json   # name: "@trivia/shared"
    ‚îú‚îÄ‚îÄ tsconfig.json
    ‚îî‚îÄ‚îÄ src/
        ‚îú‚îÄ‚îÄ types/
        ‚îÇ   ‚îú‚îÄ‚îÄ api.ts          # User, Quiz, QuizResult, AuthResponse...
        ‚îÇ   ‚îú‚îÄ‚îÄ websocket.ts    # WSMessage, QuizQuestionEvent, AnswerResult...
        ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
        ‚îú‚îÄ‚îÄ constants/
        ‚îÇ   ‚îî‚îÄ‚îÄ ws-events.ts    # WS event names –∫–∞–∫ enum/const
        ‚îî‚îÄ‚îÄ index.ts
```

### –§–∞–π–ª—ã

---

#### [NEW] `shared/` ‚Äî –Ω–æ–≤—ã–π –ø–∞–∫–µ—Ç

–í—ã–¥–µ–ª–∏—Ç—å –∏–∑ [types.ts](file:///c:/project/vmdeploy/trivia-apinewfront/src/lib/api/types.ts):
- –í—Å–µ 25 –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ (User, Quiz, QuizResult, AuthResponse, WS events –∏ —Ç.–¥.)
- –í—Å–µ type aliases (QuizStatus, EliminationReason –∏ —Ç.–¥.)

–î–æ–±–∞–≤–∏—Ç—å:
- WS event names –∏–∑ [QuizWebSocketProvider.tsx](file:///c:/project/vmdeploy/trivia-apinewfront/src/providers/QuizWebSocketProvider.tsx) –∫–∞–∫ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è runtime-–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö WS-—Å–æ–±—ã—Ç–∏–π (`quiz:question`, `quiz:answer_result`, `quiz:state`, `quiz:finish`) ‚Äî type guard —Ñ—É–Ω–∫—Ü–∏–∏

---

#### [MODIFY] [trivia-apinewfront/src/lib/api/types.ts](file:///c:/project/vmdeploy/trivia-apinewfront/src/lib/api/types.ts)

–ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ—ç–∫—Å–ø–æ—Ä—Ç –∏–∑ shared:
```typescript
export * from '@trivia/shared';
```

---

#### [MODIFY] [trivia-apinewfront/package.json](file:///c:/project/trivia-apinewfront/package.json)

–î–æ–±–∞–≤–∏—Ç—å workspace dependency:
```json
"dependencies": {
  "@trivia/shared": "workspace:*"
}
```

### Definition of Done ‚Äî –§–∞–∑–∞ 2

- [ ] `pnpm install` –≤ web-–ø—Ä–æ–µ–∫—Ç–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] `pnpm build` –≤ web-–ø—Ä–æ–µ–∫—Ç–µ ‚Äî —Å–±–æ—Ä–∫–∞ –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] Web-–∫–ª–∏–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ (—Ç–∏–ø—ã –Ω–µ –ø–æ–ª–æ–º–∞–ª–∏—Å—å)
- [ ] `shared` –ø–∞–∫–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Å–µ 25 –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
- [ ] Type guard —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è 5 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö WS-—Å–æ–±—ã—Ç–∏–π

---

## –§–∞–∑–∞ 3: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Mobile App (3‚Äì4 –¥–Ω—è)

### –ß—Ç–æ –¥–µ–ª–∞–µ–º

–°–æ–∑–¥–∞—ë–º Expo React Native –ø—Ä–æ–µ–∫—Ç —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π: –Ω–∞–≤–∏–≥–∞—Ü–∏—è, auth, API client, WS.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
trivia-mobile/
‚îú‚îÄ‚îÄ app/                        # Expo Router
‚îÇ   ‚îú‚îÄ‚îÄ (auth)/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ register.tsx
‚îÇ   ‚îú‚îÄ‚îÄ (tabs)/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _layout.tsx         # Tab navigator
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.tsx           # Home
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ leaderboard.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ profile.tsx
‚îÇ   ‚îú‚îÄ‚îÄ quiz/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ lobby.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ play.tsx
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ results.tsx
‚îÇ   ‚îú‚îÄ‚îÄ profile/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ history.tsx
‚îÇ   ‚îî‚îÄ‚îÄ _layout.tsx             # Root layout + providers
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.ts           # API client —Å Bearer auth (–Ω–µ cookies!)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts             # Login/register/refresh/logout —á–µ—Ä–µ–∑ /api/mobile/auth/*
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ quizzes.ts          # –ó–∞–ø—Ä–æ—Å—ã –∫ /api/quizzes/*
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user.ts             # /api/users/me, /api/leaderboard
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useAuth.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useQuizWS.ts        # WebSocket —Å reconnect/heartbeat
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useUserQuery.ts
‚îÇ   ‚îú‚îÄ‚îÄ providers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthProvider.tsx     # Secure Storage –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ QueryProvider.tsx    # TanStack Query
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tokenService.ts     # expo-secure-store + auto-refresh –ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ components/             # UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ constants/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.ts           # API_URL, WS_URL –ø–æ env
‚îÇ   ‚îî‚îÄ‚îÄ i18n/                   # RU/KK
‚îú‚îÄ‚îÄ app.json
‚îú‚îÄ‚îÄ eas.json
‚îú‚îÄ‚îÄ package.json                # workspace: ["../shared"]
‚îî‚îÄ‚îÄ tsconfig.json
```

### –ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –ø–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ

**API Client (–Ω–µ –∫–∞–∫ web!):**
```
Web:  credentials: 'include' + cookies + CSRF ‚Üí /api/auth/*
Mobile: Authorization: Bearer + SecureStore  ‚Üí /api/mobile/auth/*
```

**Token Storage:**
- `expo-secure-store` ‚Äî Keychain (iOS), Keystore (Android)
- Access token ‚Äî in-memory (refresh –ø—Ä–∏ app restart)
- Refresh token ‚Äî –≤ SecureStore

**Auto-refresh:**
- Interceptor –≤ API client: –µ—Å–ª–∏ 401 + `token_expired` ‚Üí refresh ‚Üí retry
- –ê–Ω–∞–ª–æ–≥ web-–ª–æ–≥–∏–∫–∏ –∏–∑ [client.ts](file:///c:/project/vmdeploy/trivia-apinewfront/src/lib/api/client.ts) (—Å—Ç—Ä–æ–∫–∏ 74-91), –Ω–æ –±–µ–∑ CSRF

**WebSocket:**
- –¢–æ—Ç –∂–µ WS-–ø—Ä–æ—Ç–æ–∫–æ–ª: `ws?ticket=<ticket>`
- Ticket –ø–æ–ª—É—á–∞–µ–º —á–µ—Ä–µ–∑ `POST /api/mobile/auth/ws-ticket` —Å Bearer
- Heartbeat 30—Å, reconnect —Å exponential backoff ‚Äî –∫–∞–∫ web
- Event names –∏–∑ `@trivia/shared`

### Definition of Done ‚Äî –§–∞–∑–∞ 3

- [ ] Expo app –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ —ç–º—É–ª—è—Ç–æ—Ä–µ/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
- [ ] Login/Register —á–µ—Ä–µ–∑ mobile endpoints —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –¢–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ SecureStore
- [ ] Auto-refresh –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ access token
- [ ] WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ mobile ws-ticket
- [ ] –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏ –±–µ–∑ –∫—Ä–∞—à–µ–π

---

## –§–∞–∑–∞ 4: –≠–∫—Ä–∞–Ω—ã (5‚Äì7 –¥–Ω–µ–π)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —ç–∫—Ä–∞–Ω–æ–≤

| # | –≠–∫—Ä–∞–Ω | –ò—Å—Ç–æ—á–Ω–∏–∫ –ø–∞—Ä–∏—Ç–µ—Ç–∞ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å |
|---|-------|-------------------|-------------|
| 1 | Login / Register | `[locale]/login/page.tsx`, `register/page.tsx` | üî¥ |
| 2 | Home (–±–ª–∏–∂–∞–π—à–∏–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã) | `[locale]/page.tsx` | üî¥ |
| 3 | Lobby | `quiz/[id]/lobby/page.tsx` | üî¥ |
| 4 | Play (WS, —Ç–∞–π–º–µ—Ä, –æ—Ç–≤–µ—Ç—ã) | `quiz/[id]/play/page.tsx` | üî¥ |
| 5 | Results | `quiz/[id]/results/page.tsx` | üî¥ |
| 6 | Leaderboard | `[locale]/leaderboard/page.tsx` | üü° |
| 7 | Profile | `[locale]/profile/page.tsx` | üü° |
| 8 | History | `[locale]/profile/history/page.tsx` | üü° |

### –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è

- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á–∏ –∏–∑ [ru.json](file:///c:/project/vmdeploy/trivia-apinewfront/messages) –∏ `kk.json`
- `i18next` + `react-i18next` –¥–ª—è mobile (Expo –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `next-intl`)
- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ –∫–∞–∫ –≤ web

### Definition of Done ‚Äî –§–∞–∑–∞ 4

- [ ] –í—Å–µ 8 —ç–∫—Ä–∞–Ω–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü–æ–ª–Ω—ã–π quiz-flow: home ‚Üí lobby ‚Üí play ‚Üí results
- [ ] WS events –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–≤–æ–ø—Ä–æ—Å—ã, —Ç–∞–π–º–µ—Ä, –æ—Ç–≤–µ—Ç—ã, –≤—ã–±—ã–≤–∞–Ω–∏–µ, —Ñ–∏–Ω–∏—à)
- [ ] –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è RU/KK —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–∞—Ö
- [ ] Ad break overlay (–µ—Å–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ)

---

## –§–∞–∑–∞ 5: –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å (3‚Äì4 –¥–Ω—è)

### Mobile-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ edge cases

| –°—Ü–µ–Ω–∞—Ä–∏–π | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|
| –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Ö–æ–¥–∏—Ç –≤ background | –°–æ—Ö—Ä–∞–Ω–∏—Ç—å state, –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ ‚Äî `user:resync` |
| –°–º–µ–Ω–∞ —Å–µ—Ç–∏ Wi-Fi ‚Üí LTE | –û–±–Ω–∞—Ä—É–∂–∏—Ç—å disconnect, reconnect —Å backoff |
| –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã | Auto-refresh –ø–µ—Ä–µ–¥ ws-ticket, retry |
| –°–ª–∞–±–∞—è —Å–µ—Ç—å / –ø–æ—Ç–µ—Ä–∏ –ø–∞–∫–µ—Ç–æ–≤ | Heartbeat + reconnect + UI-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä |
| Crash recovery | –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `quiz:state` |

### Runtime-–≤–∞–ª–∏–¥–∞—Ü–∏—è WS

–ú–∏–Ω–∏–º—É–º –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (–∏–∑ shared):
- `quiz:question` ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ `question_id`, [text](file:///c:/project/vmdeploy/trivia-apinewfront/src/providers/AuthProvider.tsx#17-32), `options`, `time_limit`
- `quiz:answer_result` ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `question_id`, `is_correct`, `is_eliminated`
- `quiz:state` ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `status`, `current_question`
- `quiz:finish` ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `quiz_id`, `status`
- `quiz:timer` ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `remaining_seconds`

### Definition of Done ‚Äî –§–∞–∑–∞ 5

- [ ] Reconnect –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–µ—Ç–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Background/foreground ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- [ ] Token refresh –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã –ø—Ä–æ–∑—Ä–∞—á–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –ù–µ—Ç –∫—Ä–∞—à–µ–π –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö WS-—Å–æ–æ–±—â–µ–Ω–∏—è—Ö

---

## –§–∞–∑–∞ 6: QA + –†–µ–ª–∏–∑ (3‚Äì5 –¥–Ω–µ–π)

### –ß–µ–∫–ª–∏—Å—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**Auth / Security:**
- [ ] Login ‚Üí –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã ‚Üí –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] Expired access token ‚Üí auto-refresh ‚Üí —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ
- [ ] Expired refresh token ‚Üí redirect –Ω–∞ login
- [ ] Logout ‚Üí —Ç–æ–∫–µ–Ω—ã –æ—á–∏—â–µ–Ω—ã –∏–∑ SecureStore
- [ ] Logout all devices ‚Üí mobile —Ç–æ–∂–µ –≤—ã–∫–∏–¥—ã–≤–∞–µ—Ç

**Quiz Flow:**
- [ ] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ lobby ‚Üí –≤–∏–¥–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- [ ] –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ WS ‚Üí –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –û—Ç–≤–µ—Ç ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ score
- [ ] –í—ã–±—ã–≤–∞–Ω–∏–µ ‚Üí UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è
- [ ] –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ results
- [ ] Reconnect mid-game ‚Üí —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ

**Web Regression (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!):**
- [ ] Web login / register —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- [ ] Web quiz flow –Ω–µ —Å–ª–æ–º–∞–ª—Å—è
- [ ] CSRF endpoints —Ä–∞–±–æ—Ç–∞—é—Ç (web cookies –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã)
- [ ] WebSocket —á–µ—Ä–µ–∑ web ws-ticket —Ä–∞–±–æ—Ç–∞–µ—Ç

**–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è:**
- [ ] RU —Ç–µ–∫—Å—Ç—ã –Ω–∞ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–∞—Ö
- [ ] KK —Ç–µ–∫—Å—Ç—ã –Ω–∞ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–∞—Ö
- [ ] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### –†–µ–ª–∏–∑–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å

```
1. Backend: –¥–µ–ø–ª–æ–π –Ω–∞ VM (–∫–∞–∫ —Å–µ–π—á–∞—Å)
2. Web: –¥–µ–ø–ª–æ–π –Ω–∞ VM (–∫–∞–∫ —Å–µ–π—á–∞—Å)
3. Mobile: EAS Build ‚Üí TestFlight (iOS) + Google Play Internal (Android)
```

Mobile –ù–ï –¥–µ–ø–ª–æ–∏—Ç—Å—è –Ω–∞ VM ‚Äî —ç—Ç–æ –Ω–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

### Definition of Done ‚Äî –§–∞–∑–∞ 6

- [ ] –í—Å–µ —á–µ–∫–ª–∏—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] Web regression ‚Äî 0 –ø–æ–ª–æ–º–æ–∫
- [ ] APK/IPA —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ EAS
- [ ] TestFlight / Google Play Internal ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è backend-–∏–∑–º–µ–Ω–µ–Ω–∏–π (–§–∞–∑–∞ 1)

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã** (9 —Ñ–∞–π–ª–æ–≤) ‚Äî –∑–∞–ø—É—Å–∫:
```bash
cd c:\project\vmdeploy\trivia-api
go test ./... -v
```

**–ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è mobile auth (–¥–æ–±–∞–≤–∏—Ç—å):**

–§–∞–π–ª: `internal/handler/mobile_auth_handler_test.go`

–¢–µ—Å—Ç-–∫–µ–π—Å—ã:
1. `TestMobileLogin_Success` ‚Äî login ‚Üí JSON —Å–æ–¥–µ—Ä–∂–∏—Ç `accessToken` –∏ [refreshToken](file:///c:/project/vmdeploy/trivia-apinewfront/src/lib/api/auth.ts#53-76)
2. `TestMobileLogin_InvalidCredentials` ‚Äî 401
3. `TestMobileRefresh_Success` ‚Äî refresh —á–µ—Ä–µ–∑ JSON body ‚Üí –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã
4. `TestMobileRefresh_InvalidToken` ‚Äî 401
5. `TestMobileWsTicket_Success` ‚Äî Bearer auth ‚Üí –ø–æ–ª—É—á–∏—Ç—å ticket
6. `TestMobileWsTicket_NoAuth` ‚Äî 401 –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
7. `TestMobileLogout_Success` ‚Äî refresh –≤ body ‚Üí 200

### –†—É—á–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è (curl/Postman)

```bash
# 1. Register
curl -X POST http://localhost:8080/api/mobile/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"mobiletest","email":"mobile@test.com","password":"pass123456"}'
# –û–∂–∏–¥–∞–Ω–∏–µ: JSON —Å accessToken, refreshToken, user

# 2. Login
curl -X POST http://localhost:8080/api/mobile/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"mobile@test.com","password":"pass123456"}'
# –û–∂–∏–¥–∞–Ω–∏–µ: JSON —Å accessToken, refreshToken

# 3. Refresh (—Å refresh_token –∏–∑ —à–∞–≥–∞ 2)
curl -X POST http://localhost:8080/api/mobile/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{"refresh_token":"<token_from_step_2>"}'
# –û–∂–∏–¥–∞–Ω–∏–µ: –Ω–æ–≤–∞—è –ø–∞—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤

# 4. WS Ticket (—Å accessToken –∏–∑ —à–∞–≥–∞ 2)
curl -X POST http://localhost:8080/api/mobile/auth/ws-ticket \
  -H "Authorization: Bearer <access_token>"
# –û–∂–∏–¥–∞–Ω–∏–µ: {"success":true,"data":{"ticket":"..."}}

# 5. Web regression: –æ–±—ã—á–Ω—ã–π login —á–µ—Ä–µ–∑ /api/auth/login
# –û–∂–∏–¥–∞–Ω–∏–µ: —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ, cookies —Å—Ç–∞–≤—è—Ç—Å—è
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏

```bash
go build ./cmd/api
go vet ./...
```

---

## –î–µ—Ä–µ–≤–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–æ–±—â–∏–π –≤–∏–¥)

```
–§–∞–∑–∞ 1 ‚Äî Backend:
  [NEW]    internal/handler/mobile_auth_handler.go        (~200 —Å—Ç—Ä–æ–∫)
  [MODIFY] internal/service/auth_service.go               (~20 —Å—Ç—Ä–æ–∫: –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ RefreshTokensMobile)
  [MODIFY] cmd/api/main.go                                (~20 —Å—Ç—Ä–æ–∫: –Ω–æ–≤–∞—è –≥—Ä—É–ø–ø–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤)
  [NEW]    internal/handler/mobile_auth_handler_test.go    (~200 —Å—Ç—Ä–æ–∫)

–§–∞–∑–∞ 2 ‚Äî Shared:
  [NEW]    shared/                                         (—Ü–µ–ª—ã–π –ø–∞–∫–µ—Ç)
  [MODIFY] trivia-apinewfront/src/lib/api/types.ts         (—Ä–µ—ç–∫—Å–ø–æ—Ä—Ç)
  [MODIFY] trivia-apinewfront/package.json                 (workspace dep)

–§–∞–∑–∞ 3‚Äì6 ‚Äî Mobile:
  [NEW]    trivia-mobile/                                  (—Ü–µ–ª—ã–π –ø—Ä–æ–µ–∫—Ç)
```

> [!IMPORTANT]
> –í—Å–µ web-–º–∞—Ä—à—Ä—É—Ç—ã, CSRF middleware, cookies ‚Äî **–ù–ò–ß–ï–ì–û –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è**. Web-–∫–ª–∏–µ–Ω—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏–¥–µ–Ω—Ç–∏—á–Ω–æ.
